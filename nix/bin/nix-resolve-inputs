#!/bin/sh

set -e

FILE="/etc/dockerfile.nix"
OUTPUT="result"
ARG_FILE=""

OPTIONS=$(getopt -o f:o:a: --long file:,output:,arg-file: -- "$@")
if [ $? -ne 0 ]; then
    echo "Incorrect options provided"
    exit 1
fi

eval set -- "$OPTIONS"

while true; do
    case "$1" in
        -f|--file)
            FILE="$2"
            shift 2
            ;;
        -o|--output)
            OUTPUT="$2"
            shift 2
            ;;
        -a|--arg-file)
            ARG_FILE="$2"
            shift 2
            ;;
        --)
            shift
            break
            ;;
        *)
            echo "Invalid option: $1"
            exit 1
            ;;
    esac
done

cmd="nix-build <dockerfile> --argstr configuration ${FILE} -A config.build.inputs -o /tmp/result"
if [[ -n "${ARG_FILE}" ]]; then
  cmd+=" --argstr ${ARG_FILE}"
fi

${cmd}
cp /tmp/result "${OUTPUT}"
